# Модель «Оценка неудовлетворенности продуктом»

> Историческое имя файла сохранено для совместимости, но актуальная метрика в проекте называется
> **«Оценка неудовлетворенности продуктом»**.

## 1. Что считается
Для каждого продукта за период считаются:
1. `totalCalls` — количество уникальных обращений (`caseId`).
2. `tagCount_i` — количество уникальных обращений, где встречался индикатор `i`.

Индикаторы:
1. `Технические проблемы/сбои`.
2. `Запрос не решен`.
3. `Отрицательный продуктовый фидбэк`.
4. `Угроза ухода/отказа от продуктов банка` (критичный).

## 2. Доли индикаторов
Для каждого индикатора рассчитывается доля:

`share_i = tagCount_i / totalCalls`

Если `totalCalls = 0`, все доли равны `0`.

## 3. Веса индикаторов
Веса считаются на глобальном срезе (по всем продуктам выбранного периода/потока):

1. Базовый индикатор: `Запрос не решен`, его вес `w2 = 1`.
2. `w1 = totalTagCount_2 / totalTagCount_1`.
3. `w3 = totalTagCount_2 / totalTagCount_3`.
4. `w4 = 50` (фиксированная константа для критичного индикатора).

Если в знаменателе ноль, используется safe divide и вес считается `0`.

## 4. Формула метрики

`productDissatisfactionScore = Σ(share_i × weight_i)`

Интерпретация:
1. Чем выше значение, тем хуже состояние продукта.
2. Размер пузыря в bubble-матрице пропорционален числу обращений (`totalCalls`).

## 5. Пороговые зоны
Пороги в текущей реализации зафиксированы константами:
1. Зеленая зона: `<= 2.117172161172161`
2. Желтая зона: между `2.117172161172161` и `4.734344322344322`
3. Красная зона: `>= 4.734344322344322`

Если пороги окажутся в обратном порядке, в коде используется `min/max` нормализация.

## 6. Где в коде (source of truth)
1. Формула и зональность:
   - `/Users/bbeglerov/Developer/Playground/graphs.bbeglerov.dev/features/insight-dashboard/logic/product-dissatisfaction-score.ts`
2. Константы порогов и фиксированный критичный вес:
   - `/Users/bbeglerov/Developer/Playground/graphs.bbeglerov.dev/features/insight-dashboard/config/constants.ts`
